#!/usr/bin/env bash
#######################
#
# Build/refresh a new site
#
#######################

OWNER="$1"
REPO="$2"
BRANCH="$3"
SLUG_BRANCH="$4"

BASE_REPO=/opt/repos
BASE_SITE=/var/www

if [ -z "$OWNER" ]; then
    echo 'Missing owner' >&2
    exit 1
fi
if [ -z "$REPO" ]; then
    echo 'Missing repo' >&2
    exit 1
fi

if [ -z "$BRANCH" ]; then
    echo 'Missing branch' >&2
    exit 1
fi

if [ ! -e "$BASE_REPO/$OWNER/$REPO" ]; then
    echo 'Repo is not registered' >&2
    exit 1
fi

cd $BASE_REPO/$OWNER/$REPO
git fetch origin $BRANCH:$BRANCH

mkdir -p $BASE_SITE/$OWNER/$REPO/$SLUG_BRANCH
cd $BASE_SITE/$OWNER/$REPO/$SLUG_BRANCH

# Either update or clone
if [ -e '.git' ]; then
    git pull
else
    git clone -b $BRANCH $BASE_REPO/$OWNER/$REPO .

    # Register the DNS entry !
    curl -X POST "https://api.cloudflare.com/client/v4/zones/c9af02bf08cf36cb8b4af704c539f0a8/dns_records" \
        -H "X-Auth-Email: info@wiredcraft.com" \
        -H "X-Auth-Key: 009d80a774051acf43d4e6196294a7221f866" \
        -H "Content-Type: application/json" \
        --data '{"type":"CNAME","name":"$SLUG_BRANCH.$REPO.$OWNER.sites.jekyllplus.com","content":"jekyllplus.com","ttl":120}'
fi

# Run the jekyll build
# need to see how

bundle exec jekyll build --destination _site